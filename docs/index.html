<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<title>残業時間記録 ― プロトタイプ版</title>
	
	<!-- load libraries -->
	<!-- jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<link type="text/css" rel="stylesheet" href="http://code.jquery.com/ui/1.12.0/themes/cupertino/jquery-ui.min.css" />

	<!-- jQuery Plugins -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.2/jstree.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />

    <!-- LINQ.js -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/linq@4.0.0/linq.min.js"></script>
</head>
<body>
	<script type="module" language="javascript">
        //■LINQ.jsからモジュール読み込み
        import Enumerable from 'https://cdn.jsdelivr.net/npm/linq@4.0.0/linq.min.js'

		$(() => {
            //■環境チェック
            //・WebStorageが利用可能な環境かどうかチェックし、利用可能でないなら警告を出して処理を終了する。
            const checkEnableWebStorage = 'checkEnableWebStorage';
            try{
                localStorage.setItem(checkEnableWebStorage, checkEnableWebStorage);
                localStorage.removeItem(checkEnableWebStorage);
            }
            catch(e){
                $('p#disableWebStorageWarning').css('display', true);
                return;
            }



            //■設定データの読み込み
            //・設定データが存在しなければ初期値を読み込む
            var load_conf_data = localStorage.getItem('conf_data');
            const conf_data = (load_conf_data !== null)
                ? JSON.parse(load_conf_data)
                : {scheduled_time: 700, break_time: 100, attendance_time: 1700, leave_time: 2430};

            //・各種表示を最新の設定情報で更新
            const refleshFormValuesByConfData = () => {
                //設定更新フォームの更新
                $('input[name=conf_schedule]').val(conf_data.scheduled_time);
                $('input[name=conf_break]').val(conf_data.break_time);
                $('input[name=conf_attendance_time]').val(conf_data.attendance_time);
                $('input[name=conf_leave_time]').val(conf_data.leave_time);

                //勤怠登録フォームの更新
                $('input[name=work_attendance_time]').val(conf_data.attendance_time);
                $('input[name=work_leave_time]').val(conf_data.leave_time);
                $('input[name=work_break_time]').val(conf_data.break_time);
            }
            refleshFormValuesByConfData();

            //■勤怠データの読み込み
            var load_working_data = localStorage.getItem('working_data');
            const working_data = (load_working_data !== null)
                ? JSON.parse(load_working_data)
                : {};
            // console.log('load working data');
            // console.log(working_data);

			const refleshWorkingDataList = () => {
                var total_extra_time = 0;
                const extract_target_query = 'tbody#extract_target_working_data';
				Enumerable.from(working_data).forEach(record => {
					const working_time = record.value.leave_time - record.value.attendance_time - record.value.break_time;
                    const extra_time = (working_time > conf_data.scheduled_time) ? working_time - conf_data.scheduled_time : 0;
                    total_extra_time += extra_time;
					const extract_target = $(extract_target_query).append(`
						<tr id="record_${record.key}">
							<td>${record.value.work_date}</td>
							<td>${record.value.attendance_time}</td>
							<td>${record.value.leave_time}</td>
							<td>${record.value.break_time}</td>
							<td>${working_time}</td>
							<td>${extra_time}</td>
						</tr>
					`);
					extract_target.add(`<td></td>`)
				});
                $(extract_target_query).append(`
                    <tr>
                        <td colspan="6">累計残業時間：${total_extra_time}</td>
                    </tr>
                `);
			} 
			refleshWorkingDataList();

            //■設定データの更新処理
            $('button[data-action=exec_updateConf]').on('click', () => {
                console.log('exec_updateConf');
                var new_conf_data = conf_data;
                new_conf_data.scheduled_time = parseInt($('input[name=conf_schedule]').val());
                new_conf_data.break_time = parseInt($('input[name=conf_break]').val());
                new_conf_data.attendance_time = parseInt($('input[name=conf_attendance_time]').val());
                new_conf_data.leave_time = parseInt($('input[name=conf_leave_time]').val());
                const new_conf_data_json = JSON.stringify(new_conf_data);
                // console.log(`new_conf_data: ${new_conf_data}`);
                // console.log(new_conf_data_json);
                localStorage.setItem('conf_data', new_conf_data_json);
                refleshFormValuesByConfData();
            })

            //■勤怠データの登録
            $('button[data-action=exec_registerWorking]').on('click', () => {
                // console.log('exec_registerWorking');
                var new_working_data = {
                    work_date: $('input[name=work_date]').val(),
                    attendance_time: $('input[name=work_attendance_time]').val(),
                    leave_time: $('input[name=work_leave_time]').val(),
                    break_time: $('input[name=work_break_time]').val(),
                }
                // console.log(new_working_data);
                working_data[$('input[name=work_date]').val()] = new_working_data;
                // console.log(working_data);
                // Enumerable.from(working_data).forEach(a => {console.log(a);});
                const working_data_json = JSON.stringify(working_data);
                // console.log(working_data_json);
                localStorage.setItem('working_data', working_data_json);
            })
		})
	</script>



    <p id="disableWebStorageWarning" style="display: none;">
        ※当ツールはWebStorageを利用しています。<br>
        ご利用の環境ではWebStorageの利用が制限されているため、当ツールはご利用いただけません。<br>
        ブラウザの設定から、WebStorageの設定を変更した上で再度アクセスしてください。
    </p>



    <form name="configure_form">
        <p>
            ●所定内労働時間<br>
            ※七時間(7:00)であれば「700」。<br>
            ※七時間(7:30)半であれば「730」。<br>
            <input type="number" name="conf_schedule">
        </p>
        <p>
            ●デフォルトの出勤時間<br>
            ※9：30出勤であれば「930」。<br>
            ※17:00出勤であれば「1700」。<br>
            <input type="number" name="conf_attendance_time">
        </p>
        <p>
            ●デフォルトの退勤時間<br>
            ※17:30退勤であれば「1730」。<br>
            ※24:30退勤であれば「2430」。<br>
            ※深夜02:00退勤であれば「2600」。<br>
            <input type="number" name="conf_leave_time">
        </p>
        <p>
            ●デフォルトの休憩時間<br>
            ※一時間(01:00)休憩の場合は「100」。<br>
            ※45分(0:45)休憩の場合は「45」。<br>
            ※休憩を取らなかった場合は「0」。<br>
            <input type="number" name="conf_break">
        </p>
        <p>
            <button type="button" data-action="exec_updateConf">設定を保存</button>
        </p>
    </form>



    <form name="register_form">
        <p>
            ●日付<br>
            <input type="date" name="work_date">
        </p>
        <p>
            ●出勤時間<br>
            ※9：30出勤であれば「930」。<br>
            ※17:00出勤であれば「1700」。<br>
            <input type="number" name="work_attendance_time">
        </p>
        <p>
            ●退勤時間<br>
            ※17:30退勤であれば「1730」。<br>
            ※24:30退勤であれば「2430」。<br>
            ※深夜02:00退勤であれば「2600」。<br>
            <input type="number" name="work_leave_time">
        </p>
        <p>
            ●休憩時間<br>
            ※一時間(01:00)休憩の場合は「100」。<br>
            ※45分(0:45)休憩の場合は「45」。<br>
            ※休憩を取らなかった場合は「0」。<br>
            <input type="number" name="work_break_time">
        </p>
        <p>
            <button type="button" data-action="exec_registerWorking">勤怠登録</button>
        </p>
    </form>

    <p>
        <table id="working_data_list">
            <thead>
                <tr>
                    <th>日付</th>
					<th>出勤時刻</th>
					<th>退勤時刻</th>
					<th>休憩時間</th>
					<th>実労働時間</th>
					<th>残業時間</th>
                </tr>
            </thead>
			<tbody id="extract_target_working_data">
			</tbody>
        </table>
    </p>
</body>
</html>